<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Box</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style2.css') }}">
</head>
<body>
    <div class="container">
        <!-- Fixed Left Sidebar -->
        <div class="sidebar">
            <h1>CSV Box</h1>
            
            <div class="nav-section">
                <h3>Operations</h3>
                <div class="nav-item active">
                    <a href="#upload">Upload</a>
                </div>
                <div class="nav-item">
                    <a href="#filter">Filter</a>
                </div>
                <div class="nav-item">
                    <a href="#transform">Transform</a>
                </div>
                <div class="nav-item">
                    <a href="#export">Export</a>
                </div>
            </div>
            
            <div class="nav-section">
                <h3>Tools</h3>
                <div class="nav-item">
                    <a href="#validate">Validate</a>
                </div>
                <div class="nav-item">
                    <a href="#merge">Merge</a>
                </div>
                <div class="nav-item">
                    <a href="#split">Split</a>
                </div>
            </div>
            
            <div class="stats" id="csvStats">
                <div class="stats-item">
                    <span class="stat-label">Rows:</span>
                    <span class="stat-value" id="rowCount">0</span>
                </div>
                <div class="stats-item">
                    <span class="stat-label">Columns:</span>
                    <span class="stat-value" id="colCount">0</span>
                </div>
                <div class="stats-item">
                    <span class="stat-label">Size:</span>
                    <span class="stat-value" id="fileSize">0 KB</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content">
            <div class="page-title">CSV Data Processor</div>
            
            <!-- File Upload Section -->
            <div class="form-section" id="uploadSection">
                <div class="form-title">Upload CSV File</div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-text">
                        <p>Drop CSV file here or click to browse</p>
                        <p class="text-muted">Supports .csv, .tsv, .txt files</p>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".csv,.tsv,.txt" />
                </div>
                
                <div class="form-group">
                    <label for="delimiter">Delimiter</label>
                    <select id="delimiter" class="form-control">
                        <option value=",">Comma (,)</option>
                        <option value=";">Semicolon (;)</option>
                        <option value="\t">Tab</option>
                        <option value="|">Pipe (|)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="encoding">Encoding</label>
                    <select id="encoding" class="form-control">
                        <option value="utf-8">UTF-8</option>
                        <option value="latin1">Latin1</option>
                        <option value="cp1252">Windows-1252</option>
                    </select>
                </div>
                
                <button type="button" class="btn" id="processBtn" disabled>Process File</button>
                <button type="button" class="btn btn-secondary" id="clearBtn">Clear</button>
                
                <div class="status-message hidden" id="statusMessage"></div>
                <div class="progress-bar hidden" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- Data Operations -->
            <div id="operationsSection" class="hidden">
                <!-- Filter Section -->
                <div class="operation-panel" id="filterPanel">
                    <div class="operation-title">Filter Data</div>
                    
                    <div class="form-group">
                        <label for="filterColumn">Column</label>
                        <select id="filterColumn" class="form-control">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterCondition">Condition</label>
                        <select id="filterCondition" class="form-control">
                            <option value="equals">Equals</option>
                            <option value="contains">Contains</option>
                            <option value="starts_with">Starts with</option>
                            <option value="ends_with">Ends with</option>
                            <option value="greater_than">Greater than</option>
                            <option value="less_than">Less than</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filterValue">Value</label>
                        <input type="text" id="filterValue" class="form-control" placeholder="Enter filter value">
                    </div>
                    
                    <button type="button" class="btn" id="applyFilterBtn">Apply Filter</button>
                    <button type="button" class="btn btn-secondary" id="clearFilterBtn">Clear Filter</button>
                </div>

                <!-- Transform Section -->
                <div class="operation-panel" id="transformPanel">
                    <div class="operation-title">Transform Data</div>
                    
                    <div class="form-group">
                        <label for="transformColumn">Column</label>
                        <select id="transformColumn" class="form-control">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="transformOperation">Operation</label>
                        <select id="transformOperation" class="form-control">
                            <option value="uppercase">Uppercase</option>
                            <option value="lowercase">Lowercase</option>
                            <option value="trim">Trim whitespace</option>
                            <option value="replace">Find & Replace</option>
                            <option value="extract_numbers">Extract numbers</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="replaceParams" style="display: none;">
                        <label for="findText">Find</label>
                        <input type="text" id="findText" class="form-control" placeholder="Text to find">
                        <label for="replaceText">Replace with</label>
                        <input type="text" id="replaceText" class="form-control" placeholder="Replacement text">
                    </div>
                    
                    <button type="button" class="btn" id="applyTransformBtn">Apply Transform</button>
                </div>

                <!-- Column Selection -->
                <div class="operation-panel" id="columnPanel">
                    <div class="operation-title">Select Columns</div>
                    
                    <div class="column-selector" id="columnSelector">
                        <!-- Columns will be populated dynamically -->
                    </div>
                    
                    <button type="button" class="btn" id="selectAllBtn">Select All</button>
                    <button type="button" class="btn btn-secondary" id="deselectAllBtn">Deselect All</button>
                </div>
            </div>

            <!-- Data Preview -->
            <div id="previewSection" class="hidden">
                <div class="preview-title">Data Preview</div>
                
                <div class="csv-stats" id="dataStats">
                    <div class="stat-item">
                        <span class="stat-label">Total Rows:</span>
                        <span class="stat-value" id="totalRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Filtered Rows:</span>
                        <span class="stat-value" id="filteredRows">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Selected Columns:</span>
                        <span class="stat-value" id="selectedCols">0</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHead">
                            <!-- Headers will be populated dynamically -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center">
                    <button type="button" class="btn" id="exportBtn">Export CSV</button>
                    <button type="button" class="btn btn-secondary" id="exportJsonBtn">Export JSON</button>
                </div>
            </div>

            <!-- Raw Data View -->
            <div id="rawDataSection" class="hidden">
                <div class="preview-title">Raw Data</div>
                <div class="preview-content" id="rawDataContent">
                    <!-- Raw CSV content will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let csvData = [];
        let filteredData = [];
        let selectedColumns = [];
        let currentFile = null;

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // File upload handling
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processFile);
        clearBtn.addEventListener('click', clearAll);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                currentFile = file;
                processBtn.disabled = false;
                showStatus(`Selected: ${file.name} (${formatFileSize(file.size)})`, 'success');
                updateStats(0, 0, file.size);
            }
        }

        function processFile() {
            if (!currentFile) return;

            const delimiter = document.getElementById('delimiter').value;
            const encoding = document.getElementById('encoding').value;

            showProgress(true);
            showStatus('Processing file...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    csvData = parseCSV(csv, delimiter);
                    filteredData = [...csvData];
                    
                    populateColumnSelectors();
                    updatePreview();
                    showOperations(true);
                    showPreview(true);
                    
                    showStatus(`Processed ${csvData.length} rows successfully`, 'success');
                    updateStats(csvData.length, csvData[0] ? csvData[0].length : 0, currentFile.size);
                } catch (error) {
                    showStatus(`Error processing file: ${error.message}`, 'error');
                }
                showProgress(false);
            };
            
            reader.readAsText(currentFile, encoding);
        }

        function parseCSV(text, delimiter) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(delimiter);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter);
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            
            return data;
        }

        function populateColumnSelectors() {
            if (csvData.length === 0) return;
            
            const columns = Object.keys(csvData[0]);
            selectedColumns = [...columns];
            
            // Populate filter column selector
            const filterColumn = document.getElementById('filterColumn');
            const transformColumn = document.getElementById('transformColumn');
            const columnSelector = document.getElementById('columnSelector');
            
            filterColumn.innerHTML = '<option value="">Select column...</option>';
            transformColumn.innerHTML = '<option value="">Select column...</option>';
            columnSelector.innerHTML = '';
            
            columns.forEach(column => {
                // Filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = column;
                filterOption.textContent = column;
                filterColumn.appendChild(filterOption);
                
                // Transform dropdown
                const transformOption = document.createElement('option');
                transformOption.value = column;
                transformOption.textContent = column;
                transformColumn.appendChild(transformOption);
                
                // Column selector checkboxes
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                columnItem.innerHTML = `
                    <input type="checkbox" id="col_${column}" value="${column}" checked>
                    <label for="col_${column}">${column}</label>
                `;
                columnSelector.appendChild(columnItem);
            });
        }

        function updatePreview() {
            const dataTable = document.getElementById('dataTable');
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tableHead.innerHTML = '';
                tableBody.innerHTML = '<tr><td>No data to display</td></tr>';
                return;
            }
            
            // Update headers
            const columns = selectedColumns.length > 0 ? selectedColumns : Object.keys(filteredData[0]);
            tableHead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
            
            // Update body (show first 100 rows)
            const displayData = filteredData.slice(0, 100);
            tableBody.innerHTML = displayData.map(row => 
                `<tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
            ).join('');
            
            // Update stats
            document.getElementById('totalRows').textContent = csvData.length;
            document.getElementById('filteredRows').textContent = filteredData.length;
            document.getElementById('selectedCols').textContent = columns.length;
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        function showProgress(show) {
            if (show) {
                progressBar.classList.remove('hidden');
                progressFill.style.width = '100%';
            } else {
                progressBar.classList.add('hidden');
                progressFill.style.width = '0%';
            }
        }

        function showOperations(show) {
            document.getElementById('operationsSection').classList.toggle('hidden', !show);
        }

        function showPreview(show) {
            document.getElementById('previewSection').classList.toggle('hidden', !show);
        }

        function updateStats(rows, cols, size) {
            document.getElementById('rowCount').textContent = rows;
            document.getElementById('colCount').textContent = cols;
            document.getElementById('fileSize').textContent = formatFileSize(size);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function clearAll() {
            csvData = [];
            filteredData = [];
            selectedColumns = [];
            currentFile = null;
            fileInput.value = '';
            processBtn.disabled = true;
            showOperations(false);
            showPreview(false);
            updateStats(0, 0, 0);
            showStatus('Cleared all data', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showOperations(false);
            showPreview(false);
        });
    </script>
</body>
</html>
